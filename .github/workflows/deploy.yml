name: Unity Headless server build
on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAME: ${{ secrets.ALI_ACR_REGISTRY }}/${{ secrets.ALI_ACR_NAMESPACE }}/${{ secrets.ALI_ACR_REPO }}

jobs:
  build_push_deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (with LFS if used)
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Verify build files exist
        run: |
          ls -la server_build
          test -f server_build/MyGameServer.x86_64
          test -d server_build/MyGameServer_Data

      - name: Login to Alibaba ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ secrets.ALI_ACR_REGISTRY }}
          username: ${{ secrets.ALI_ACR_USERNAME }}
          password: ${{ secrets.ALI_ACR_PASSWORD }}

      - name: Build & Push Docker image to ACR
        run: |          
          docker build -t $IMAGE_NAME:latest .
          docker push $IMAGE_NAME:latest

      - name: Deploy on ECS (pull + restart)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.HOST_IP }}
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |            
            sudo -i
            sudo docker login ${{ secrets.ALI_ACR_REGISTRY }} -u ${{ secrets.ALI_ACR_USERNAME }} -p ${{ secrets.ALI_ACR_PASSWORD }}

            cd /root/unity-networking
            export ACR_IMAGE="${{env.IMAGE_NAME}}:latest"

            sudo docker compose pull
            sudo docker compose up -d

            sudo docker ps
            sudo docker logs --tail 50 unity-server
